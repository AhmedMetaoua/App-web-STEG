<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur de Performance des Jobs</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
        }

        .control-item label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .control-item input, .control-item select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .control-item input:focus, .control-item select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .navigation {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .breadcrumb-item {
            padding: 8px 16px;
            background: #f8f9fa;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .breadcrumb-item:hover {
            background: #e9ecef;
            border-color: #3498db;
        }

        .breadcrumb-item.active {
            background: #3498db;
            color: white;
        }

        .breadcrumb-separator {
            color: #6c757d;
            font-weight: bold;
        }

        .job-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .job-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .job-item:hover {
            background: #e9ecef;
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .job-item.folder::before {
            content: "üìÅ";
            font-size: 1.2rem;
        }

        .job-item.job::before {
            content: "‚öôÔ∏è";
            font-size: 1.2rem;
        }

        .job-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .main-content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: 4px solid #3498db;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .control-group {
                grid-template-columns: 1fr;
            }
            
            .job-grid {
                grid-template-columns: 1fr;
            }
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            padding: 10px 20px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .btn-email {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
        }

        .btn-email:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .email-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .email-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
        }

        .email-modal h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .email-modal input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .email-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Analyseur de Performance des Jobs</h1>
            <p>Analyse automatis√©e des temps d'ex√©cution avec s√©lection de p√©riode personnalis√©e</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="dbHost">Serveur MySQL</label>
                    <input type="text" id="dbHost" value="localhost" placeholder="localhost">
                </div>
                <div class="control-item">
                    <label for="dbUser">Utilisateur</label>
                    <input type="text" id="dbUser" value="root" placeholder="root">
                </div>
                <div class="control-item">
                    <label for="dbPassword">Mot de passe</label>
                    <input type="password" id="dbPassword" value="azerty" placeholder="Mot de passe">
                </div>
                <div class="control-item">
                    <label for="dbName">Base de donn√©es</label>
                    <input type="text" id="dbName" value="scheduler_test" placeholder="scheduler_test">
                </div>
            </div>
            <div class="control-group">
                <div class="control-item">
                    <label for="startDate">Date de d√©but</label>
                    <input type="date" id="startDate" value="2025-05-01">
                </div>
                <div class="control-item">
                    <label for="endDate">Date de fin</label>
                    <input type="date" id="endDate" value="2025-05-31">
                </div>
                <div class="control-item">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="connectAndLoadData()">üîÑ Charger les donn√©es</button>
                </div>
            </div>
        </div>

        <div class="navigation">
            <div class="breadcrumb" id="breadcrumb">
                <div class="breadcrumb-item active" onclick="navigateToPath([])">üè† Racine</div>
            </div>
            <div class="job-grid" id="jobGrid">
                <div class="loading">Chargement des donn√©es...</div>
            </div>
        </div>

        <div class="main-content">
            <div class="stats-grid" id="statsGrid" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="avgDuration">-</div>
                    <div class="stat-label">Dur√©e moyenne (min)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="maxDuration">-</div>
                    <div class="stat-label">Dur√©e maximum (min)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="minDuration">-</div>
                    <div class="stat-label">Dur√©e minimum (min)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalExecutions">-</div>
                    <div class="stat-label">Ex√©cutions totales</div>
                </div>
            </div>
            <div class="chart-container" id="chartContainer" style="display: none;">
                <div id="performanceChart"></div>
                <div class="action-buttons" id="actionButtons" style="display: none;">
                    <button class="btn-secondary" onclick="saveSingleJobPDF()">
                        üìÑ Sauvegarder PDF (Job actuel)
                    </button>
                    <button class="btn-secondary" onclick="saveAllJobsPDF()">
                        üìÅ Sauvegarder PDF (Tous les jobs)
                    </button>
                    <button class="btn-secondary btn-email" onclick="showEmailModal('single')">
                        üìß Envoyer par email (Job actuel)
                    </button>
                    <button class="btn-secondary btn-email" onclick="showEmailModal('all')">
                        üìß Envoyer par email (Tous les jobs)
                    </button>
                </div>
            </div>
        </div>

        <div id="emailModal" class="email-modal" style="display: none;">
            <div class="email-modal-content">
                <h3>üìß Envoi par email</h3>
                <input type="email" id="emailAddress" placeholder="Adresse email de destination" required>
                <input type="text" id="emailSubject" placeholder="Objet du message" value="Rapport d'analyse des jobs">
                <textarea id="emailMessage" placeholder="Message (optionnel)" rows="4" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; margin-bottom: 15px; font-size: 16px; resize: vertical;"></textarea>
                <div class="email-modal-buttons">
                    <button class="btn-cancel" onclick="hideEmailModal()">Annuler</button>
                    <button class="btn" onclick="sendEmail()">Envoyer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let allJobsData = [];
        let currentPath = [];
        let currentJobData = null;
        let currentEmailType = '';

        // Donn√©es simul√©es pour la d√©monstration
        // const sampleData = [
        //     {
        //         JOB_NAME: "sos/dailyplan/CreateDailyPlan",
        //         START_TIME: "2025-05-01 08:00:00",
        //         END_TIME: "2025-05-01 08:15:00"
        //     },
        //     {
        //         JOB_NAME: "sos/dailyplan/CreateDailyPlan",
        //         START_TIME: "2025-05-02 08:00:00",
        //         END_TIME: "2025-05-02 08:12:00"
        //     },
        //     {
        //         JOB_NAME: "sos/dailyplan/StartDailyPlanOnce",
        //         START_TIME: "2025-05-01 09:00:00",
        //         END_TIME: "2025-05-01 09:25:00"
        //     },
        //     {
        //         JOB_NAME: "sos/managed/scheduler_managed_starter",
        //         START_TIME: "2025-05-01 10:00:00",
        //         END_TIME: "2025-05-01 10:05:00"
        //     },
        //     {
        //         JOB_NAME: "reports/monthly/GenerateReport",
        //         START_TIME: "2025-05-01 11:00:00",
        //         END_TIME: "2025-05-01 11:30:00"
        //     },
        //     {
        //         JOB_NAME: "backup/daily/DatabaseBackup",
        //         START_TIME: "2025-05-01 02:00:00",
        //         END_TIME: "2025-05-01 02:45:00"
        //     }
        // ];

        // Connexion r√©elle √† la base de donn√©es via l'API Flask
        async function connectAndLoadData() {
            const dbHost = document.getElementById('dbHost').value;
            const dbUser = document.getElementById('dbUser').value;
            const dbPassword = document.getElementById('dbPassword').value;
            const dbName = document.getElementById('dbName').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // Validation des dates
            if (!startDate || !endDate) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner une date de d√©but et une date de fin');
                return;
            }

            if (new Date(startDate) >= new Date(endDate)) {
                alert('‚ö†Ô∏è La date de d√©but doit √™tre ant√©rieure √† la date de fin');
                return;
            }

            // Affichage du chargement
            document.getElementById('jobGrid').innerHTML = '<div class="loading">Connexion √† la base de donn√©es...</div>';
            
            // Supprimer les anciens messages
            const oldMessages = document.querySelectorAll('.success, .error');
            oldMessages.forEach(msg => msg.remove());

            try {
                const response = await fetch('http://localhost:5000/api/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        host: dbHost,
                        user: dbUser,
                        password: dbPassword,
                        database: dbName,
                        port: 3306,
                        startDate: startDate,
                        endDate: endDate
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Traitement des donn√©es r√©elles
                    allJobsData = result.data;
                    renderJobNavigation();
                    
                    // Calcul du nombre de jours
                    const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
                    
                    // Message de succ√®s
                    const successMsg = document.createElement('div');
                    successMsg.className = 'success';
                    successMsg.innerHTML = `
                        ${result.message}<br>
                        <small>P√©riode: ${startDate} au ${endDate} (${daysDiff} jours) | Total: ${result.total_records} | Filtr√©s: ${result.filtered_records} jobs</small>
                    `;
                    document.querySelector('.controls').appendChild(successMsg);
                    
                    setTimeout(() => successMsg.remove(), 8000);
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }

            } catch (error) {
                console.error('Erreur de connexion:', error);
                
                // Message d'erreur
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error';
                errorMsg.innerHTML = `
                    <strong>‚ùå Erreur de connexion</strong><br>
                    ${error.message}<br>
                    <small>V√©rifiez que le serveur Flask est d√©marr√© sur http://localhost:5000</small>
                `;
                document.querySelector('.controls').appendChild(errorMsg);
                
                // Fallback sur les donn√©es de d√©monstration
                document.getElementById('jobGrid').innerHTML = '<div class="loading">Utilisation des donn√©es de d√©monstration...</div>';
                setTimeout(() => {
                    allJobsData = processJobData(sampleData, startDate, endDate);
                    renderJobNavigation();
                }, 1000);
                
                setTimeout(() => errorMsg.remove(), 8000);
            }
        }

        // Traitement des donn√©es des jobs
        function processJobData(rawData, startDate, endDate) {
            const processedData = [];
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);

            rawData.forEach(row => {
                const startTime = new Date(row.START_TIME);
                const endTime = new Date(row.END_TIME);
                
                if (startTime >= startDateObj && startTime <= endDateObj) {
                    const duration = (endTime - startTime) / (1000 * 60); // en minutes
                    const date = startTime.toISOString().split('T')[0];
                    
                    processedData.push({
                        jobName: row.JOB_NAME,
                        startTime: startTime,
                        endTime: endTime,
                        duration: duration,
                        date: date
                    });
                }
            });

            return processedData;
        }

        // Construction de la hi√©rarchie des jobs
        function buildJobHierarchy(data) {
            const hierarchy = {};
            
            data.forEach(job => {
                const parts = job.jobName.split('/');
                let current = hierarchy;
                
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (!current[part]) {
                        current[part] = {
                            isJob: i === parts.length - 1,
                            children: {},
                            data: []
                        };
                    }
                    if (current[part].isJob) {
                        current[part].data.push(job);
                    }
                    current = current[part].children;
                }
            });
            
            return hierarchy;
        }

        // Rendu de la navigation des jobs
        function renderJobNavigation() {
            const hierarchy = buildJobHierarchy(allJobsData);
            let currentLevel = hierarchy;
            
            // Naviguer vers le niveau actuel
            for (const pathItem of currentPath) {
                currentLevel = currentLevel[pathItem].children;
            }
            
            const jobGrid = document.getElementById('jobGrid');
            jobGrid.innerHTML = '';
            
            // Afficher les √©l√©ments du niveau actuel
            Object.keys(currentLevel).forEach(key => {
                const item = currentLevel[key];
                const jobItem = document.createElement('div');
                jobItem.className = `job-item ${item.isJob ? 'job' : 'folder'}`;
                jobItem.innerHTML = `<span class="job-name">${key}</span>`;
                
                if (item.isJob) {
                    jobItem.onclick = () => showJobAnalysis(key, item.data);
                } else {
                    jobItem.onclick = () => navigateToPath([...currentPath, key]);
                }
                
                jobGrid.appendChild(jobItem);
            });
            
            // Mettre √† jour le breadcrumb
            updateBreadcrumb();
        }

        // Mise √† jour du breadcrumb
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = '<div class="breadcrumb-item" onclick="navigateToPath([])">üè† Racine</div>';
            
            for (let i = 0; i < currentPath.length; i++) {
                const separator = document.createElement('div');
                separator.className = 'breadcrumb-separator';
                separator.textContent = '/';
                breadcrumb.appendChild(separator);
                
                const item = document.createElement('div');
                item.className = 'breadcrumb-item';
                item.textContent = currentPath[i];
                item.onclick = () => navigateToPath(currentPath.slice(0, i + 1));
                breadcrumb.appendChild(item);
            }
            
            // Marquer le dernier √©l√©ment comme actif
            const lastItem = breadcrumb.lastElementChild;
            if (lastItem) {
                lastItem.classList.add('active');
            }
        }

        // Navigation vers un chemin
        function navigateToPath(path) {
            currentPath = path;
            renderJobNavigation();
            hideJobAnalysis();
        }

        // Affichage de l'analyse d'un job
        function showJobAnalysis(jobName, jobData) {
            currentJobData = jobData;
            
            // Calculer les statistiques
            const durations = jobData.map(d => d.duration);
            const avgDuration = durations.reduce((a, b) => a + b, 0) / durations.length;
            const maxDuration = Math.max(...durations);
            const minDuration = Math.min(...durations);
            const totalExecutions = jobData.length;
            
            // Mettre √† jour les statistiques
            document.getElementById('avgDuration').textContent = avgDuration.toFixed(1);
            document.getElementById('maxDuration').textContent = maxDuration.toFixed(1);
            document.getElementById('minDuration').textContent = minDuration.toFixed(1);
            document.getElementById('totalExecutions').textContent = totalExecutions;
            
            // Afficher les sections
            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('actionButtons').style.display = 'flex'; // Show action buttons
            
            // G√©n√©rer le graphique
            generateChart(jobName, jobData, avgDuration, maxDuration, minDuration);
        }

        // Masquer l'analyse
        function hideJobAnalysis() {
            document.getElementById('statsGrid').style.display = 'none';
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none'; // Hide action buttons
        }

        // G√©n√©ration du graphique
        function generateChart(jobName, jobData, avgDuration, maxDuration, minDuration) {
            // Agr√©gation par date
            const dailyData = {};
            jobData.forEach(job => {
                if (!dailyData[job.date]) {
                    dailyData[job.date] = 0;
                }
                dailyData[job.date] += job.duration;
            });
            
            const dates = Object.keys(dailyData).sort();
            const durations = dates.map(date => dailyData[date]);
            
            const trace = {
                x: dates,
                y: durations,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Dur√©e quotidienne',
                line: {
                    color: '#3498db',
                    width: 3
                },
                marker: {
                    color: '#3498db',
                    size: 8,
                    line: {
                        color: 'white',
                        width: 2
                    }
                },
                hovertemplate: '<b>%{x}</b><br>Dur√©e: %{y:.1f} min<extra></extra>'
            };
            
            const avgLine = {
                x: dates,
                y: Array(dates.length).fill(avgDuration),
                type: 'scatter',
                mode: 'lines',
                name: 'Moyenne globale',
                line: {
                    color: 'orange',
                    width: 2,
                    dash: 'dash'
                },
                hovertemplate: 'Moyenne: %{y:.1f} min<extra></extra>'
            };
            
            const maxLine = {
                x: dates,
                y: Array(dates.length).fill(maxDuration),
                type: 'scatter',
                mode: 'lines',
                name: 'Maximum global',
                line: {
                    color: 'red',
                    width: 2,
                    dash: 'dash'
                },
                hovertemplate: 'Maximum: %{y:.1f} min<extra></extra>'
            };
            
            const minLine = {
                x: dates,
                y: Array(dates.length).fill(minDuration),
                type: 'scatter',
                mode: 'lines',
                name: 'Minimum global',
                line: {
                    color: 'green',
                    width: 2,
                    dash: 'dash'
                },
                hovertemplate: 'Minimum: %{y:.1f} min<extra></extra>'
            };
            
            const layout = {
                title: {
                    text: `Analyse de performance - ${jobName}`,
                    font: {
                        size: 20,
                        color: '#2c3e50'
                    }
                },
                xaxis: {
                    title: 'Date',
                    tickangle: -45,
                    gridcolor: '#f0f0f0'
                },
                yaxis: {
                    title: 'Dur√©e (minutes)',
                    gridcolor: '#f0f0f0'
                },
                hovermode: 'closest',
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255,255,255,0.8)'
                },
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                margin: {
                    l: 60,
                    r: 40,
                    t: 60,
                    b: 80
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
            };
            
            Plotly.newPlot('performanceChart', [trace, avgLine, maxLine, minLine], layout, config);
        }

        // Save single job PDF
        async function saveSingleJobPDF() {
            if (!currentJobData || currentJobData.length === 0) {
                alert('‚ö†Ô∏è Aucun job s√©lectionn√© pour g√©n√©rer le PDF');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ G√©n√©ration en cours...';
            button.disabled = true;

            try {
                // Get current job name from breadcrumb or path
                const jobName = [...currentPath].pop() || 'Job Analysis';
                
                const response = await fetch('http://localhost:5000/api/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'single',
                        jobName: jobName,
                        jobData: currentJobData
                    })
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la g√©n√©ration du PDF');
                }

                // Download the PDF
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analysis_${jobName.replace(/[\/\\:*?"<>|]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showSuccessMessage('‚úÖ PDF g√©n√©r√© et t√©l√©charg√© avec succ√®s');

            } catch (error) {
                console.error('Erreur PDF:', error);
                showErrorMessage('‚ùå Erreur lors de la g√©n√©ration du PDF: ' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Save all jobs PDF
        async function saveAllJobsPDF() {
            if (!allJobsData || allJobsData.length === 0) {
                alert('‚ö†Ô∏è Aucune donn√©e disponible pour g√©n√©rer le PDF');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ G√©n√©ration en cours...';
            button.disabled = true;

            try {
                const response = await fetch('http://localhost:5000/api/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'all',
                        allJobsData: allJobsData
                    })
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la g√©n√©ration du PDF');
                }

                // Download the PDF
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analysis_all_jobs_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showSuccessMessage('‚úÖ PDF complet g√©n√©r√© et t√©l√©charg√© avec succ√®s');

            } catch (error) {
                console.error('Erreur PDF:', error);
                showErrorMessage('‚ùå Erreur lors de la g√©n√©ration du PDF: ' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Show email modal
        function showEmailModal(type) {
            currentEmailType = type;
            const modal = document.getElementById('emailModal');
            const subject = document.getElementById('emailSubject');
            
            if (type === 'single') {
                const jobName = [...currentPath].pop() || 'Job Analysis';
                subject.value = `Rapport d'analyse - ${jobName}`;
                document.getElementById('emailMessage').value = `Veuillez trouver ci-joint le rapport d'analyse pour le job: ${jobName}`;
            } else {
                subject.value = 'Rapport d\'analyse complet - Tous les jobs';
                document.getElementById('emailMessage').value = 'Veuillez trouver ci-joint le rapport d\'analyse complet de tous les jobs.';
            }
            
            modal.style.display = 'flex';
        }

        // Hide email modal
        function hideEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
            document.getElementById('emailAddress').value = '';
            currentEmailType = '';
        }

        // Send email
        async function sendEmail() {
            const emailAddress = document.getElementById('emailAddress').value;
            const emailSubject = document.getElementById('emailSubject').value;
            const emailMessage = document.getElementById('emailMessage').value;

            if (!emailAddress) {
                alert('‚ö†Ô∏è Veuillez saisir une adresse email');
                return;
            }

            if (!emailAddress.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                alert('‚ö†Ô∏è Veuillez saisir une adresse email valide');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ Envoi en cours...';
            button.disabled = true;

            try {
                let requestData = {
                    type: currentEmailType,
                    email: emailAddress,
                    subject: emailSubject,
                    message: emailMessage
                };

                if (currentEmailType === 'single') {
                    if (!currentJobData || currentJobData.length === 0) {
                        throw new Error('Aucun job s√©lectionn√©');
                    }
                    const jobName = [...currentPath].pop() || 'Job Analysis';
                    requestData.jobName = jobName;
                    requestData.jobData = currentJobData;
                } else {
                    if (!allJobsData || allJobsData.length === 0) {
                        throw new Error('Aucune donn√©e disponible');
                    }
                    requestData.allJobsData = allJobsData;
                }

                const response = await fetch('http://localhost:5000/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccessMessage('‚úÖ Email envoy√© avec succ√®s √† ' + emailAddress);
                    hideEmailModal();
                } else {
                    throw new Error(result.error || 'Erreur lors de l\'envoi');
                }

            } catch (error) {
                console.error('Erreur email:', error);
                showErrorMessage('‚ùå Erreur lors de l\'envoi: ' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Helper functions for success/error messages
        function showSuccessMessage(message) {
            const successMsg = document.createElement('div');
            successMsg.className = 'success';
            successMsg.innerHTML = message;
            document.querySelector('.controls').appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 5000);
        }

        function showErrorMessage(message) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error';
            errorMsg.innerHTML = message;
            document.querySelector('.controls').appendChild(errorMsg);
            setTimeout(() => errorMsg.remove(), 8000);
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('emailModal');
            if (event.target === modal) {
                hideEmailModal();
            }
        });


        // Initialisation avec tentative de connexion r√©elle
        window.onload = async function() {
            // Test de connexion au serveur Flask
            try {
                const response = await fetch('http://localhost:5000/api/test');
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Serveur Flask d√©tect√©:', result.message);
                    
                    // Message d'information
                    const infoMsg = document.createElement('div');
                    infoMsg.className = 'success';
                    infoMsg.innerHTML = `
                        <strong>üöÄ Serveur Flask connect√©</strong><br>
                        <small>Pr√™t pour la connexion √† MySQL</small>
                    `;
                    document.querySelector('.controls').appendChild(infoMsg);
                    setTimeout(() => infoMsg.remove(), 3000);
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Serveur Flask non d√©tect√©, utilisation des donn√©es de d√©monstration');
                
                // Chargement des donn√©es de d√©monstration
                setTimeout(() => {
                    allJobsData = processJobData(sampleData, "2025-05-01", "2025-05-31");
                    renderJobNavigation();
                    
                    const warningMsg = document.createElement('div');
                    warningMsg.className = 'error';
                    warningMsg.innerHTML = `
                        <strong>‚ö†Ô∏è Mode d√©monstration</strong><br>
                        Serveur Flask non disponible. D√©marrez le serveur backend pour utiliser vos vraies donn√©es.
                    `;
                    document.querySelector('.controls').appendChild(warningMsg);
                    setTimeout(() => warningMsg.remove(), 5000);
                }, 1000);
            }
        };
    </script>

    
</body>
</html>